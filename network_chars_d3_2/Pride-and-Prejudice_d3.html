<!DOCTYPE html>
<!-- source: http://bl.ocks.org/MoritzStefaner/1377729 (no license info) -->

<body>
<svg width="960" height="600"></svg>
<script src="https://d3js.org/d3.v2.js"></script>
<script>

var labelDistance = 0;

var vis = d3.select("svg");
    w = +vis.attr("width"),
    h = +vis.attr("height");

var json = {"nodes": [{"group": 1, "name": "MRS BENNET"}, {"group": 1, "name": "MR BENNET"}, {"group": 1, "name": "KITTY"}, {"group": 1, "name": "ELIZABETH"}, {"group": 1, "name": "MARY"}, {"group": 1, "name": "BINGLEY"}, {"group": 1, "name": "JANE"}, {"group": 1, "name": "LYDIA"}, {"group": 1, "name": "COLLINS"}, {"group": 1, "name": "MR COLLINS"}, {"group": 1, "name": "CHARLOTTE"}, {"group": 1, "name": "WICKHAM"}, {"group": 1, "name": "MR GARDINER"}, {"group": 1, "name": "MRS GARDINER"}, {"group": 1, "name": "CAROLINE BINGLEY"}, {"group": 1, "name": "DARCY"}], "links": [{"target": 1, "weight": 20, "source": 0}, {"target": 2, "weight": 7, "source": 0}, {"target": 3, "weight": 23, "source": 0}, {"target": 4, "weight": 5, "source": 0}, {"target": 5, "weight": 5, "source": 0}, {"target": 6, "weight": 12, "source": 0}, {"target": 7, "weight": 6, "source": 0}, {"target": 3, "weight": 7, "source": 8}, {"target": 9, "weight": 5, "source": 8}, {"target": 10, "weight": 6, "source": 8}, {"target": 2, "weight": 5, "source": 11}, {"target": 3, "weight": 8, "source": 11}, {"target": 7, "weight": 7, "source": 11}, {"target": 2, "weight": 5, "source": 1}, {"target": 3, "weight": 19, "source": 1}, {"target": 4, "weight": 5, "source": 1}, {"target": 6, "weight": 6, "source": 1}, {"target": 3, "weight": 16, "source": 2}, {"target": 5, "weight": 5, "source": 2}, {"target": 6, "weight": 10, "source": 2}, {"target": 7, "weight": 12, "source": 2}, {"target": 5, "weight": 8, "source": 3}, {"target": 12, "weight": 6, "source": 3}, {"target": 13, "weight": 8, "source": 3}, {"target": 4, "weight": 8, "source": 3}, {"target": 14, "weight": 6, "source": 3}, {"target": 9, "weight": 6, "source": 3}, {"target": 15, "weight": 19, "source": 3}, {"target": 6, "weight": 19, "source": 3}, {"target": 7, "weight": 15, "source": 3}, {"target": 10, "weight": 11, "source": 3}, {"target": 13, "weight": 6, "source": 12}, {"target": 5, "weight": 5, "source": 14}, {"target": 15, "weight": 6, "source": 14}, {"target": 15, "weight": 6, "source": 5}, {"target": 6, "weight": 7, "source": 5}, {"target": 10, "weight": 5, "source": 9}, {"target": 10, "weight": 6, "source": 15}, {"target": 7, "weight": 7, "source": 6}]};

var labelAnchors = [];
var labelAnchorLinks = [];


for(var i = 0; i < json.nodes.length; i++) {
	labelAnchors.push({
		node : json.nodes[i]
	});
	labelAnchors.push({
		node : json.nodes[i]
	});
	labelAnchorLinks.push({
		source : i * 2,
		target : i * 2 + 1,
		weight : 1
	});
};


var force = d3.layout.force()
	.size([w, h])
	.nodes(json.nodes)
	.links(json.links)
	.gravity(1)
	.linkDistance(200)
	.charge(-3000)
	.linkStrength(function(x) {
		return x.weight
	}
);

force.start();

var force2 = d3.layout.force()
	.nodes(labelAnchors)
	.links(labelAnchorLinks)
	.gravity(0)
	.linkDistance(0)
	.linkStrength(8)
	.charge(-100)
	.size([w, h]);

force2.start();

var link = vis.selectAll("line.link")
	.data(json.links)
	.enter()
	.append("svg:line")
	.attr("class", "link")
	.style("stroke", "#CCC")
	.style("stroke-width", function(d) { return d.weight/2; });


var node = vis.selectAll("g.node")
	.data(force.nodes())
	.enter()
	.append("svg:g")
	.attr("class", "node");

node.append("svg:circle")
	.attr("r", 5)
	.style("fill", "#555")
	.style("stroke", "#FFF")
	.style("stroke-width", 3);

node.call(force.drag);


var anchorLink = vis.selectAll("line.anchorLink")
	.data(labelAnchorLinks)//.enter().append("svg:line").attr("class", "anchorLink").style("stroke", "#999");

var anchorNode = vis.selectAll("g.anchorNode")
	.data(force2.nodes())
	.enter()
	.append("svg:g")
	.attr("class", "anchorNode");

anchorNode.append("svg:circle")
	.attr("r", 0)
	.style("fill", "#FFF");

anchorNode.append("svg:text")
	.text(function(d, i) {
		return i % 2 == 0 ? "" : d.node.name
	})
	.style("fill", "#555")
	.style("font-family", "Arial")
	.style("font-size", 12);

var updateLink = function() {
	this.attr("x1", function(d) {
		return d.source.x;
	}).attr("y1", function(d) {
		return d.source.y;
	}).attr("x2", function(d) {
		return d.target.x;
	}).attr("y2", function(d) {
		return d.target.y;
	});

}

var updateNode = function() {
	this.attr("transform", function(d) {
		return "translate(" + d.x + "," + d.y + ")";
	});

}


force.on("tick", function() {

	force2.start();

	node.call(updateNode);

	anchorNode.each(function(d, i) {
		if(i % 2 == 0) {
			d.x = d.node.x;
			d.y = d.node.y;
		} else {
			var b = this.childNodes[1].getBBox();

			var diffX = d.x - d.node.x;
			var diffY = d.y - d.node.y;

			var dist = Math.sqrt(diffX * diffX + diffY * diffY);

			var shiftX = b.width * (diffX - dist) / (dist * 2);
			shiftX = Math.max(-b.width, Math.min(0, shiftX));
			var shiftY = 5;
			this.childNodes[1].setAttribute("transform", "translate(" + shiftX + "," + shiftY + ")");
		}
	});


	anchorNode.call(updateNode);

	link.call(updateLink);
	anchorLink.call(updateLink);

});

</script>
</body>
</html>